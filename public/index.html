<script>
function getUserId() {
  let uid = localStorage.getItem("ruleta_uid");
  if (!uid) {
    uid = "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem("ruleta_uid", uid);
  }
  return uid;
}

// Elementos importantes (ajust√° los id a tu HTML si cambian)
const spinBtn = document.getElementById('spinButton');
const popup   = document.getElementById('winnerPopup');
const winnerMsg  = document.getElementById('winnerMessage');
const winnerDate = document.getElementById('winnerDate');
const winnerBtn  = document.getElementById('winnerButton');
const dailyCounter = document.getElementById('dailyCounter');

// Dibujo de la rueda (puede quedarse igual)
const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
const segments = 7; // mismo n√∫mero de premios que el backend
const anglePer = (2 * Math.PI) / segments;
let currentAngle = 0;
const colors = ["#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500"];

function drawWheel(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=0;i<segments;i++){
    ctx.beginPath();
    ctx.moveTo(170,170);
    ctx.arc(170,170,170,currentAngle+i*anglePer,currentAngle+(i+1)*anglePer);
    ctx.closePath();
    ctx.fillStyle = colors[i%colors.length];
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.stroke();
  }
}
drawWheel();

function spinWheel(callback){
  const spins = 5 + Math.random()*3;
  const endAngle = (2*Math.PI)*spins;
  let start = null;
  function animate(ts){
    if(!start) start = ts;
    const progress = (ts-start)/3500;
    if(progress<1){
      currentAngle = endAngle * (1 - Math.pow(1 - progress, 3));
      drawWheel();
      requestAnimationFrame(animate);
    } else {
      drawWheel();
      callback();
    }
  }
  requestAnimationFrame(animate);
}

function showPopup(msg,date,cajero){
  winnerMsg.textContent  = msg;
  winnerDate.textContent = date ? `Fecha: ${date}` : '';
  popup.classList.add('show');
  winnerBtn.onclick = () => {
    const texto = encodeURIComponent(
      `Hola ${cajero.nombre}! Gan√© ${msg} el ${date} y quisiera reclamarlo.`
    );
    window.open(`https://wa.me/54${cajero.numero}?text=${texto}`, '_blank');
  };
}

function startCounter(msLeft){
  const timer = setInterval(()=>{
    if(msLeft <=0){ clearInterval(timer); dailyCounter.textContent=''; return; }
    const h = Math.floor(msLeft/3600000);
    const m = Math.floor((msLeft%3600000)/60000);
    dailyCounter.textContent = `Siguiente giro en: ${h}h ${m}m`;
    msLeft -= 60000;
  },60000);
}

spinBtn.addEventListener('click', ()=>{
  spinBtn.disabled = true;
  spinWheel(()=>{
    fetch('/girar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ usuarioId: getUserId() })
    })
    .then(r => r.json())
    .then(data => {
      if (data.yaGiro) {
        showPopup(data.mensaje,null,{nombre:'',numero:''});
      } else {
        showPopup(`Ganaste üéâ ${data.premio} üéâ`,
                  new Date().toLocaleString(),
                  data.cajero);
      }
    })
    .catch(()=> showPopup('Error de conexi√≥n',null,{nombre:'',numero:''}))
    .finally(()=> spinBtn.disabled = false);
  });
});
</script>
