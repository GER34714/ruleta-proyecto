<!-- ...todo tu HTML antes igual... -->

<script>
const spinBtn = document.getElementById('spinButton');
const popup = document.getElementById('winnerPopup');
const winnerMsg = document.getElementById('winnerMessage');
const winnerDate = document.getElementById('winnerDate');
const winnerReturn = document.getElementById('winnerReturn');
const winnerBtn = document.getElementById('winnerButton');
const closeBtn  = document.getElementById('closeButton');
const dailyCounter = document.getElementById('dailyCounter');

const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');

function getUserId(){
  let uid = localStorage.getItem("ruleta_uid");
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem("ruleta_uid", uid);
  }
  return uid;
}

const colors = ["#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500"];
let numSegments = 7;
let angleStep = (2*Math.PI)/numSegments;
let currentAngle = 0;

function drawWheel(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=0;i<numSegments;i++){
    ctx.beginPath();
    ctx.moveTo(170,170);
    ctx.arc(170,170,170,currentAngle+i*angleStep,currentAngle+(i+1)*angleStep);
    ctx.closePath();
    ctx.fillStyle = colors[i%colors.length];
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.stroke();
  }
}
drawWheel();

function spinWheel(){
  spinBtn.disabled = true;
  const spinTime = 4000;
  const spinAngle = Math.random()*360 + 1800;
  const startAngle = currentAngle;
  const targetAngle = startAngle + spinAngle;
  const startTime = performance.now();

  function animate(time){
    let elapsed = time - startTime;
    if(elapsed < spinTime){
      const progress = elapsed / spinTime;
      currentAngle = startAngle + (spinAngle * (1 - Math.pow(1 - progress, 3)));
      drawRotatedWheel(currentAngle);
      requestAnimationFrame(animate);
    } else {
      currentAngle = targetAngle;
      drawRotatedWheel(currentAngle);
      requestResult();
    }
  }
  requestAnimationFrame(animate);
}

function drawRotatedWheel(angle){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(170,170);
  ctx.rotate(angle * Math.PI / 180);
  ctx.translate(-170,-170);
  drawWheel();
  ctx.restore();
}

function requestResult(){
  fetch("/girar", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ usuarioId:getUserId() })
  })
  .then(r => r.json())
  .then(data => {
    if(data.yaGiro){
      winnerMsg.textContent = "Ganaste ðŸŽ‰ " + (data.premio || "") + " ðŸŽ‰";
      winnerReturn.textContent = data.mensaje;
      winnerDate.textContent = "";
    } else {
      winnerMsg.textContent = "Ganaste ðŸŽ‰ " + data.premio + " ðŸŽ‰";
      winnerDate.textContent = "Fecha y hora: " + new Date().toLocaleString();
      winnerReturn.textContent = "â³ PodrÃ¡s volver a girar en 24 horas. El premio se acredita en tu segunda carga.";
      winnerBtn.onclick = () => {
        const msg = encodeURIComponent(
          `Hola ${data.cajero.nombre}! GanÃ© ${data.premio} el ${new Date().toLocaleString()} (en tu segunda carga) y quisiera reclamarlo.`
        );
        window.open(`https://wa.me/54${data.cajero.numero}?text=${msg}`,"_blank");
      };
    }

    // MOSTRAR FRASE RANDOM DE SUERTE
    if (data.fraseSuerte) {
      let fraseEl = document.getElementById('fraseSuerte');
      if (!fraseEl) {
        fraseEl = document.createElement('div');
        fraseEl.id = 'fraseSuerte';
        fraseEl.style.marginTop = '8px';
        fraseEl.style.color = '#ff0';
        fraseEl.style.fontWeight = 'bold';
        fraseEl.style.textShadow = '0 0 6px #000,0 0 12px #000';
        winnerReturn.parentNode.appendChild(fraseEl);
      }
      fraseEl.textContent = data.fraseSuerte;
    }

    popup.classList.add('show');
  })
  .catch(() => { alert("Error de conexiÃ³n. Intenta mÃ¡s tarde."); })
  .finally(() => { spinBtn.disabled = false; });
}

spinBtn.addEventListener('click', spinWheel);
closeBtn.addEventListener('click', () => popup.classList.remove('show'));
</script>
